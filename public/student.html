<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Student | Inspired Homework</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <header>
      <h1>Student workspace</h1>
      <p>Launch homework from Canvas or use a shared link from your teacher.</p>
      <div class="pill-list">
        <a class="pill" href="/">Back to overview</a>
      </div>
    </header>

    <section class="card">
      <div class="form-grid">
        <div>
          <label for="assignmentId">Assignment ID</label>
          <input id="assignmentId" placeholder="Paste the link or ID" />
        </div>
        <div style="display: flex; align-items: flex-end;">
          <button id="load">Load homework</button>
        </div>
      </div>
      <p class="note">Links from Canvas include the assignmentId query automatically.</p>
      <div id="content" style="margin-top: 16px;"></div>
    </section>

    <script>
      const content = document.getElementById('content');
      const input = document.getElementById('assignmentId');

      const tutorModal = document.createElement('div');
      tutorModal.id = 'tutorModal';
      tutorModal.className = 'modal hidden';
      tutorModal.innerHTML = `
        <div class="modal-overlay" id="tutorOverlay"></div>
        <div class="modal-content">
          <div class="modal-header">
            <div>
              <h3>Homework Tutor</h3>
              <p class="small">A PRIZM content player to step through your tasks.</p>
            </div>
            <button id="closeTutor" class="secondary">Exit</button>
          </div>
          <div class="tutor-grid">
            <div class="tutor-pane" id="tutorTasks"><p class="small">Load an assignment to view tasks.</p></div>
            <div class="tutor-pane" id="tutorPlayer"><p class="small">Select a task to preview details.</p></div>
          </div>
        </div>
      `;
      document.body.appendChild(tutorModal);

      function openTutor(assignment) {
        const tasksEl = document.getElementById('tutorTasks');
        const playerEl = document.getElementById('tutorPlayer');
        if (!assignment || !assignment.tasks.length) {
          tasksEl.innerHTML = '<p class="small">No tasks available to preview.</p>';
          playerEl.innerHTML = '<p class="small">Add tasks to see them here.</p>';
        } else {
          tasksEl.innerHTML = assignment.tasks
            .map(
              (task, idx) => `
                <button class="tutor-task" data-index="${idx}">
                  <span class="badge">${idx + 1}</span>
                  <span>${task}</span>
                </button>
              `
            )
            .join('');
          const buttons = tasksEl.querySelectorAll('.tutor-task');
          buttons.forEach((btn) => {
            btn.addEventListener('click', () => {
              buttons.forEach((b) => b.classList.remove('active'));
              btn.classList.add('active');
              const task = assignment.tasks[Number(btn.dataset.index)];
              playerEl.innerHTML = `
                <div class="player-pane">
                  <h4>Task ${Number(btn.dataset.index) + 1}</h4>
                  <p>${task}</p>
                  <p class="small">Use the external launch link to complete this task in a new Berlin Chatbot tab.</p>
                </div>
              `;
            });
          });
          buttons[0]?.click();
        }

        tutorModal.classList.remove('hidden');
        tutorModal.classList.add('open');
      }

      function closeTutor() {
        tutorModal.classList.remove('open');
        tutorModal.classList.add('hidden');
      }

      tutorModal.querySelector('#closeTutor').addEventListener('click', closeTutor);
      tutorModal.querySelector('#tutorOverlay').addEventListener('click', closeTutor);

      function renderAssignment(assignment, launchUrl) {
        if (!assignment) {
          content.innerHTML = '<p class="small">Assignment not found.</p>';
          return;
        }

        const taskItems = assignment.tasks.length
          ? `<ul>${assignment.tasks.map((task) => `<li>${task}</li>`).join('')}</ul>`
          : '<p class="small">No tasks yet.</p>';

        content.innerHTML = `
          <div class="assignment-card">
            <div class="badge">${assignment.students.length ? 'Individual or group' : 'Shared link'}</div>
            <h3>${assignment.title}</h3>
            <p class="small">${assignment.description || 'No description provided.'}</p>
            <div>
              <strong>Tasks</strong>
              ${taskItems}
            </div>
            <p class="small">Launch URL: <a href="${launchUrl}" target="_blank" rel="noopener">Open in new tab</a></p>
            <div style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap;">
              <button class="secondary" id="openTutor">Open PRIZM Homework player</button>
            </div>
          </div>
        `;

        const tutorButton = document.getElementById('openTutor');
        tutorButton?.addEventListener('click', () => openTutor(assignment));
      }

      async function loadAssignment(id) {
        const response = await fetch(`/api/assignments/${id}`);
        if (!response.ok) {
          renderAssignment(null);
          return;
        }
        const data = await response.json();
        renderAssignment(data.assignment, data.launchUrl);
      }

      document.getElementById('load').addEventListener('click', () => {
        const raw = input.value.trim();
        const id = raw.includes('assignmentId=')
          ? new URL(raw).searchParams.get('assignmentId')
          : raw;
        if (id) loadAssignment(id);
      });

      const urlId = new URLSearchParams(window.location.search).get('assignmentId');
      if (urlId) {
        input.value = urlId;
        loadAssignment(urlId);
      }
    </script>
  </body>
</html>
