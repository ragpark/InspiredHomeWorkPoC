<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Teacher | Inspired Homework</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/styles.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
            colors: {
              primary: {
                50: '#eef2ff',
                100: '#e0e7ff',
                500: '#4f46e5',
                600: '#4338ca',
                700: '#3730a3',
              },
            },
          },
        },
      };
    </script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-slate-50 text-slate-900">
    <div id="root"></div>
    <script type="text/babel">
      const { useEffect, useState, useMemo } = React;

      const Card = ({ title, subtitle, actions, children }) => (
        <section className="bg-white shadow-sm rounded-xl border border-slate-200 p-6 space-y-4">
          <div className="flex items-start justify-between gap-4">
            <div>
              <h2 className="text-lg font-semibold text-slate-900">{title}</h2>
              {subtitle && <p className="text-sm text-slate-500 mt-1">{subtitle}</p>}
            </div>
            {actions}
          </div>
          <div className="space-y-4">{children}</div>
        </section>
      );

      const SectionHeader = ({ eyebrow, title, description }) => (
        <div className="flex flex-col gap-2">
          <span className="text-xs uppercase tracking-wide text-primary-600 font-semibold">{eyebrow}</span>
          <h1 className="text-3xl font-semibold text-slate-900">{title}</h1>
          <p className="text-sm text-slate-600 leading-relaxed">{description}</p>
        </div>
      );

      const Badge = ({ children }) => (
        <span className="inline-flex items-center rounded-full bg-primary-50 text-primary-700 text-xs font-medium px-2.5 py-1">
          {children}
        </span>
      );

      function TeacherApp() {
        const [learners, setLearners] = useState([]);
        const [scheme, setScheme] = useState(null);
        const [resources, setResources] = useState([]);
        const [assignments, setAssignments] = useState([]);
        const [form, setForm] = useState({
          title: '',
          description: '',
          tasks: '',
          students: '',
          groups: '',
          returnUrl: '',
        });
        const [selectedLearners, setSelectedLearners] = useState(new Set());
        const [status, setStatus] = useState('');
        const [aiStatus, setAiStatus] = useState('');
        const [aiExplain, setAiExplain] = useState('');
        const [aiForm, setAiForm] = useState({
          learnerId: '',
          topic: '',
          week: 1,
          time: 30,
          profile: 'balanced',
          explain: false,
        });

        const topics = useMemo(() => {
          if (!scheme) return [];
          const schemeTopics = scheme.semesters.flatMap((sem) => sem.weeks.map((w) => w.topic));
          const resourceTopics = resources.map((r) => r.topic);
          return Array.from(new Set([...schemeTopics, ...resourceTopics])).sort();
        }, [scheme, resources]);

        useEffect(() => {
          async function load() {
            const [learnerRes, schemeRes, resourceRes, assignmentRes] = await Promise.all([
              fetch('/api/learners'),
              fetch('/api/scheme-of-work'),
              fetch('/api/content-resources'),
              fetch('/api/assignments'),
            ]);
            const learnersData = await learnerRes.json();
            const schemeData = await schemeRes.json();
            const resourceData = await resourceRes.json();
            const assignmentData = await assignmentRes.json();
            setLearners(learnersData.learners || []);
            setScheme(schemeData.schemeOfWork || null);
            setResources(resourceData.resources || []);
            setAssignments(assignmentData.assignments || []);
          }
          load();
        }, []);

        const overview = useMemo(
          () => [
            { label: 'Learners', value: learners.length || 0 },
            { label: 'Weeks planned', value: scheme ? scheme.semesters.reduce((sum, sem) => sum + sem.weeks.length, 0) : 0 },
            { label: 'Content items', value: resources.length || 0 },
            { label: 'Assignments', value: assignments.length || 0 },
          ],
          [learners, scheme, resources, assignments]
        );

        const handleFormChange = (key, value) => setForm((prev) => ({ ...prev, [key]: value }));

        const toggleLearner = (id) => {
          setSelectedLearners((prev) => {
            const next = new Set(prev);
            if (next.has(id)) next.delete(id);
            else next.add(id);
            return next;
          });
        };

        const addResourceToTasks = (resource) => {
          const line = `${resource.title} (${resource.type}, ${resource.lengthMinutes} mins, ${resource.topic})`;
          handleFormChange('tasks', form.tasks ? `${form.tasks}\n${line}` : line);
        };

        const resolveProfile = (value) => {
          if (value === 'core') return { Foundation: 0.2, Core: 0.6, Stretch: 0.2 };
          if (value === 'stretch') return { Foundation: 0.1, Core: 0.4, Stretch: 0.5 };
          return { Foundation: 0.3, Core: 0.5, Stretch: 0.2 };
        };

        const applyRecommendation = (data) => {
          const homework = data.homework || {};
          if (!form.title && homework.title) handleFormChange('title', homework.title);
          if (!form.description && homework.description) handleFormChange('description', homework.description);
          if (homework.tasks && Array.isArray(homework.tasks)) {
            handleFormChange(
              'tasks',
              homework.tasks
                .map((task) => task.taskText || '')
                .filter(Boolean)
                .join('\n')
            );
          }
          const explanations = data.explanations || {};
          const notes = (explanations.notes || []).map((note) => `• ${note}`).join('\n');
          setAiExplain([explanations.global, notes].filter(Boolean).join('\n'));
          setAiStatus('Suggestion applied. Adjust anything before sending.');
        };

        const generateAi = async (calendarAware = false) => {
          setAiStatus('');
          setAiExplain('');
          const { learnerId, topic, week, time, profile, explain } = aiForm;
          if (!learnerId || !topic) {
            setAiStatus('Pick a learner and topic to generate a plan.');
            return;
          }
          const payload = {
            learnerId,
            topic,
            maxTotalTimeMinutes: Number(time) || 30,
            difficultyProfile: resolveProfile(profile),
            explain,
          };
          let endpoint = '/api/recommend-homework';
          if (calendarAware) {
            payload.weekNumber = Number(week) || 1;
            payload.topicOverride = topic;
            endpoint = '/api/recommendations/calendar-aware';
          }
          try {
            setAiStatus('Generating...');
            const res = await fetch(endpoint, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || 'Could not generate recommendations');
            applyRecommendation(data);
          } catch (err) {
            setAiStatus(err.message);
          }
        };

        const submitAssignment = async () => {
          setStatus('Saving...');
          const payload = {
            title: form.title,
            description: form.description,
            tasks: form.tasks
              .split('\n')
              .map((t) => t.trim())
              .filter(Boolean),
            students: form.students
              .split(',')
              .map((s) => s.trim())
              .filter(Boolean)
              .concat(Array.from(selectedLearners)),
            groups: form.groups
              .split(',')
              .map((g) => g.trim())
              .filter(Boolean),
            ltiReturnUrl: form.returnUrl.trim() || undefined,
          };
          const res = await fetch('/api/assignments', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (res.ok) {
            setStatus(`Created! Launch: ${data.studentLaunchLink}`);
            setAssignments((prev) => [...prev, data.assignment]);
          } else {
            setStatus(data.error || 'Failed to create assignment');
          }
        };

        return (
          <div className="max-w-6xl mx-auto px-4 py-10 space-y-8">
            <SectionHeader
              eyebrow="Teacher workspace"
              title="Plan, personalise, and publish homework"
              description="Task-oriented layout that keeps assignment details, AI suggestions, and distribution controls in one place."
            />

            <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
              {overview.map((item) => (
                <div key={item.label} className="bg-white border border-slate-200 rounded-xl p-4 shadow-sm">
                  <p className="text-sm text-slate-500">{item.label}</p>
                  <p className="text-2xl font-semibold text-slate-900">{item.value}</p>
                </div>
              ))}
            </div>

            <Card
              title="Assignment essentials"
              subtitle="Capture the basics before assigning to learners."
              actions={<Badge>Task builder</Badge>}
            >
              <div className="grid gap-4 md:grid-cols-2">
                <label className="flex flex-col gap-2">
                  <span className="text-sm font-medium text-slate-700">Title</span>
                  <input
                    className="input"
                    placeholder="Fractions practice"
                    value={form.title}
                    onChange={(e) => handleFormChange('title', e.target.value)}
                  />
                </label>
                <label className="flex flex-col gap-2">
                  <span className="text-sm font-medium text-slate-700">Notes for students</span>
                  <input
                    className="input"
                    placeholder="Key reminders or instructions"
                    value={form.description}
                    onChange={(e) => handleFormChange('description', e.target.value)}
                  />
                </label>
              </div>
              <label className="flex flex-col gap-2">
                <span className="text-sm font-medium text-slate-700">Tasks (one per line)</span>
                <textarea
                  className="input h-28"
                  placeholder="Read chapter 5\nSolve problems 1-10\nSubmit screenshots"
                  value={form.tasks}
                  onChange={(e) => handleFormChange('tasks', e.target.value)}
                />
              </label>
              <div className="grid gap-4 md:grid-cols-2">
                <label className="flex flex-col gap-2">
                  <span className="text-sm font-medium text-slate-700">Student emails or IDs</span>
                  <input
                    className="input"
                    placeholder="ada@example.com, brian@example.com"
                    value={form.students}
                    onChange={(e) => handleFormChange('students', e.target.value)}
                  />
                </label>
                <label className="flex flex-col gap-2">
                  <span className="text-sm font-medium text-slate-700">Groups</span>
                  <input
                    className="input"
                    placeholder="Period 2, Algebra Club"
                    value={form.groups}
                    onChange={(e) => handleFormChange('groups', e.target.value)}
                  />
                </label>
              </div>
              <label className="flex flex-col gap-2">
                <span className="text-sm font-medium text-slate-700">Canvas deep-link return URL (optional)</span>
                <input
                  className="input"
                  placeholder="https://canvas.example.com/courses/123/assignments"
                  value={form.returnUrl}
                  onChange={(e) => handleFormChange('returnUrl', e.target.value)}
                />
              </label>
              <div className="flex flex-wrap items-center gap-3">
                <button className="btn" onClick={submitAssignment}>
                  Create assignment
                </button>
                {status && <span className="text-sm text-slate-600">{status}</span>}
              </div>
            </Card>

            <Card
              title="AI suggestions"
              subtitle="Blend learner, topic, difficulty, and calendar context before assigning."
              actions={<Badge>Recommendation</Badge>}
            >
              <div className="grid gap-4 md:grid-cols-2">
                <label className="flex flex-col gap-2">
                  <span className="text-sm font-medium text-slate-700">Learner</span>
                  <select
                    className="input"
                    value={aiForm.learnerId}
                    onChange={(e) => setAiForm((p) => ({ ...p, learnerId: e.target.value }))}
                  >
                    <option value="">Select a learner</option>
                    {learners.map((l) => (
                      <option key={l.id} value={l.id}>
                        {l.name} ({l.id})
                      </option>
                    ))}
                  </select>
                </label>
                <label className="flex flex-col gap-2">
                  <span className="text-sm font-medium text-slate-700">Topic</span>
                  <select
                    className="input"
                    value={aiForm.topic}
                    onChange={(e) => setAiForm((p) => ({ ...p, topic: e.target.value }))}
                  >
                    <option value="">Pick a topic</option>
                    {topics.map((topic) => (
                      <option key={topic} value={topic}>
                        {topic}
                      </option>
                    ))}
                  </select>
                </label>
              </div>
              <div className="grid gap-4 md:grid-cols-3">
                <label className="flex flex-col gap-2">
                  <span className="text-sm font-medium text-slate-700">Time budget (minutes)</span>
                  <input
                    className="input"
                    type="number"
                    min="5"
                    step="5"
                    value={aiForm.time}
                    onChange={(e) => setAiForm((p) => ({ ...p, time: e.target.value }))}
                  />
                </label>
                <label className="flex flex-col gap-2">
                  <span className="text-sm font-medium text-slate-700">Difficulty profile</span>
                  <select
                    className="input"
                    value={aiForm.profile}
                    onChange={(e) => setAiForm((p) => ({ ...p, profile: e.target.value }))}
                  >
                    <option value="balanced">Balanced</option>
                    <option value="core">Mostly Core</option>
                    <option value="stretch">Stretch</option>
                  </select>
                </label>
                <label className="flex flex-col gap-2">
                  <span className="text-sm font-medium text-slate-700">Academic week</span>
                  <input
                    className="input"
                    type="number"
                    min="1"
                    max="18"
                    value={aiForm.week}
                    onChange={(e) => setAiForm((p) => ({ ...p, week: e.target.value }))}
                  />
                </label>
              </div>
              <div className="flex items-center gap-3 flex-wrap">
                <label className="inline-flex items-center gap-2 text-sm text-slate-700">
                  <input
                    type="checkbox"
                    checked={aiForm.explain}
                    onChange={(e) => setAiForm((p) => ({ ...p, explain: e.target.checked }))}
                  />
                  Explain choices
                </label>
                <div className="flex gap-2 flex-wrap">
                  <button className="btn" onClick={() => generateAi(false)}>
                    Generate tasks
                  </button>
                  <button className="btn-secondary" onClick={() => generateAi(true)}>
                    Calendar-aware suggestion
                  </button>
                </div>
                {aiStatus && <span className="text-sm text-slate-600">{aiStatus}</span>}
              </div>
              {aiExplain && (
                <pre className="bg-slate-50 border border-slate-200 rounded-lg p-4 text-sm text-slate-800 whitespace-pre-wrap">
                  {aiExplain}
                </pre>
              )}
            </Card>

            <div className="grid gap-6 lg:grid-cols-2">
              <Card title="Learner selection" subtitle="Choose individuals or groups to receive the assignment." actions={<Badge>Audience</Badge>}>
                <div className="grid gap-3 sm:grid-cols-2">
                  {learners.map((learner) => (
                    <label
                      key={learner.id}
                      className={`flex items-start gap-3 border rounded-lg p-3 cursor-pointer transition hover:border-primary-300 ${
                        selectedLearners.has(learner.email) ? 'border-primary-400 bg-primary-50/60' : 'border-slate-200'
                      }`}
                    >
                      <input
                        type="checkbox"
                        checked={selectedLearners.has(learner.email)}
                        onChange={() => toggleLearner(learner.email)}
                        className="mt-1"
                      />
                      <div className="space-y-1">
                        <p className="font-semibold text-slate-900">{learner.name}</p>
                        <p className="text-sm text-slate-600">{learner.email}</p>
                        <p className="text-xs text-slate-500">{learner.cohort} · {learner.status}</p>
                      </div>
                    </label>
                  ))}
                </div>
              </Card>

              <Card title="Calendar & scheme" subtitle="Understand weekly focus and attach matching content." actions={<Badge>Schedule</Badge>}>
                <div className="space-y-3">
                  {scheme?.semesters.map((sem) => (
                    <div key={sem.name} className="border border-slate-200 rounded-lg p-3 space-y-2">
                      <div className="flex items-center justify-between">
                        <div>
                          <p className="font-semibold text-slate-900">{sem.name}</p>
                          <p className="text-sm text-slate-600">{sem.focus}</p>
                        </div>
                        <Badge>{sem.weeks.length} weeks</Badge>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        {sem.weeks.map((week) => (
                          <span key={week.week} className="px-3 py-1 rounded-full bg-slate-100 text-xs text-slate-700">
                            Week {week.week}: {week.topic}
                          </span>
                        ))}
                      </div>
                    </div>
                  )) || <p className="text-sm text-slate-600">No scheme loaded.</p>}
                </div>
              </Card>
            </div>

            <Card
              title="Content library"
              subtitle="Browse resources by topic and add them into the task list."
              actions={<Badge>Resources</Badge>}
            >
              <div className="flex items-center gap-3 flex-wrap">
                <label className="text-sm text-slate-700">Filter by topic</label>
                <select
                  className="input w-64"
                  value={aiForm.topic}
                  onChange={(e) => setAiForm((p) => ({ ...p, topic: e.target.value }))}
                >
                  <option value="">All topics</option>
                  {topics.map((topic) => (
                    <option key={topic} value={topic}>
                      {topic}
                    </option>
                  ))}
                </select>
              </div>
              <div className="grid gap-3 md:grid-cols-2">
                {(resources
                  .filter((r) => !aiForm.topic || r.topic === aiForm.topic)
                  .map((resource) => (
                    <div key={resource.id} className="border border-slate-200 rounded-lg p-4 flex items-start justify-between gap-3">
                      <div className="space-y-1">
                        <p className="font-semibold text-slate-900">{resource.title}</p>
                        <p className="text-sm text-slate-600">{resource.topic}</p>
                        <p className="text-xs text-slate-500">{resource.type} · {resource.difficulty} · {resource.lengthMinutes} mins</p>
                      </div>
                      <button className="btn-secondary" onClick={() => addResourceToTasks(resource)}>
                        Add
                      </button>
                    </div>
                  ))) || <p className="text-sm text-slate-600">No resources available.</p>}
              </div>
            </Card>

            <Card title="Recent assignments" subtitle="Reuse links or confirm launches before posting to Canvas." actions={<Badge>History</Badge>}>
              <div className="grid gap-3 md:grid-cols-2">
                {assignments.length === 0 && <p className="text-sm text-slate-600">No assignments yet.</p>}
                {assignments.map((assignment) => (
                  <div key={assignment.id} className="border border-slate-200 rounded-lg p-4 space-y-2">
                    <div className="flex items-center justify-between">
                      <p className="font-semibold text-slate-900">{assignment.title}</p>
                      <Badge>{assignment.tasks.length} tasks</Badge>
                    </div>
                    <p className="text-sm text-slate-600">{assignment.description || 'No description provided.'}</p>
                    <p className="text-xs text-slate-500">Created {new Date(assignment.createdAt).toLocaleString()}</p>
                    <div className="text-xs text-slate-600 break-all">
                      Launch: {window.location.origin}/student.html?assignmentId={assignment.id}
                    </div>
                  </div>
                ))}
              </div>
            </Card>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<TeacherApp />);
    </script>
  </body>
</html>
