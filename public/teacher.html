<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Assignment Studio | Inspired Homework</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            serif: ['Crimson Pro', 'Georgia', 'serif'],
            sans: ['Inter', 'ui-sans-serif', 'system-ui']
          },
          colors: {
            primary: {
              50: '#f0f4ff',
              100: '#e0eaff',
              200: '#c7d7fe',
              300: '#a4bcfc',
              400: '#8195f8',
              500: '#6366f1',
              600: '#4f46e5',
              700: '#4338ca',
              800: '#3730a3',
              900: '#312e81',
            },
            accent: {
              50: '#fefce8',
              100: '#fef9c3',
              200: '#fef08a',
              300: '#fde047',
              400: '#facc15',
              500: '#eab308',
              600: '#ca8a04',
              700: '#a16207',
              800: '#854d0e',
              900: '#713f12',
            },
            slate: {
              25: '#fcfcfd',
              950: '#0a0c12',
            }
          },
          spacing: {
            18: '4.5rem',
            88: '22rem',
          },
          animation: {
            'slide-up': 'slideUp 0.6s ease-out forwards',
            'fade-in': 'fadeIn 0.4s ease-out forwards',
            'scale-in': 'scaleIn 0.3s ease-out forwards',
          },
          keyframes: {
            slideUp: {
              '0%': { transform: 'translateY(20px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' }
            },
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' }
            },
            scaleIn: {
              '0%': { transform: 'scale(0.95)', opacity: '0' },
              '100%': { transform: 'scale(1)', opacity: '1' }
            }
          }
        },
      },
    };
  </script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    .step-indicator { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .step-indicator.active { transform: scale(1.1); }
    .floating-action { box-shadow: 0 8px 30px rgba(99, 102, 241, 0.3); transition: all 0.3s ease; }
    .floating-action:hover { transform: translateY(-2px); box-shadow: 0 12px 40px rgba(99, 102, 241, 0.4); }
    .resource-card { transition: all 0.2s ease; }
    .resource-card:hover { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); }
    .workflow-nav { position: sticky; top: 0; z-index: 50; background: rgba(248, 250, 252, 0.95); backdrop-filter: blur(8px); }
    @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .pulse-soft { animation: pulse-soft 2s infinite; }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-25 via-slate-50 to-primary-50 min-h-screen antialiased">
  <div id="root"></div>
  <script type="text/babel">
    const { useEffect, useState, useMemo } = React;

    const StepIndicator = ({ step, currentStep, title, isComplete, onClick }) => (
      <button
        onClick={onClick}
        className={`step-indicator flex items-center gap-4 p-4 rounded-xl text-left transition-all duration-200 ${
          currentStep === step
            ? 'bg-gradient-to-br from-primary-500 to-primary-600 text-white shadow-xl scale-105'
            : isComplete
            ? 'bg-primary-50 text-primary-800 border-2 border-primary-200 hover:bg-primary-100 hover:border-primary-300 shadow-sm'
            : 'bg-white text-slate-600 border-2 border-slate-200 hover:bg-slate-50 hover:border-slate-300 shadow-sm'
        }`}
      >
        <div
          className={`w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold shadow-sm transition-all duration-200 ${
            currentStep === step
              ? 'bg-white/25 backdrop-blur-sm'
              : isComplete
              ? 'bg-primary-500 text-white'
              : 'bg-slate-100 text-slate-500'
          }`}
        >
          {isComplete && currentStep !== step ? '✓' : step}
        </div>
        <div className="flex-1">
          <div className={`font-semibold ${currentStep === step ? 'text-base' : 'text-sm'}`}>{title}</div>
        </div>
      </button>
    );

    const ModernCard = ({ children, className = '', hover = false }) => (
      <div
        className={`bg-white rounded-2xl border-2 border-slate-200 shadow-sm ${hover ? 'hover:shadow-lg hover:border-slate-300' : ''} transition-all duration-200 ${className}`}
      >
        {children}
      </div>
    );

    const FloatingActionButton = ({ onClick, children, variant = 'primary' }) => (
      <button
        onClick={onClick}
        className={`floating-action px-6 py-3.5 rounded-xl font-bold text-sm transition-all duration-200 shadow-lg ${
          variant === 'primary'
            ? 'bg-gradient-to-r from-primary-500 to-primary-600 text-white hover:from-primary-600 hover:to-primary-700 hover:shadow-xl hover:-translate-y-0.5'
            : 'bg-white text-slate-700 border-2 border-slate-300 hover:bg-slate-50 hover:border-slate-400 hover:shadow-xl'
        }`}
      >
        {children}
      </button>
    );

    const ResourceCard = ({ resource, onAdd }) => (
      <ModernCard className="resource-card p-5" hover>
        <div className="flex items-start justify-between gap-4">
          <div className="flex-1 space-y-2.5">
            <div className="flex items-start gap-2 flex-wrap">
              <h4 className="font-semibold text-slate-900 text-base flex-1">{resource.title}</h4>
              <span
                className={`px-2.5 py-1 text-xs rounded-lg font-semibold shadow-sm ${
                  resource.difficulty === 'Foundation'
                    ? 'bg-gradient-to-r from-green-100 to-green-200 text-green-800 border border-green-300'
                    : resource.difficulty === 'Core'
                    ? 'bg-gradient-to-r from-blue-100 to-blue-200 text-blue-800 border border-blue-300'
                    : 'bg-gradient-to-r from-purple-100 to-purple-200 text-purple-800 border border-purple-300'
                }`}
              >
                {resource.difficulty}
              </span>
            </div>
            <p className="text-sm text-slate-600 font-medium">{resource.topic}</p>
            <div className="flex items-center gap-3 text-xs text-slate-500">
              <span className="flex items-center gap-1">
                <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                </svg>
                {resource.type}
              </span>
              <span>•</span>
              <span className="flex items-center gap-1">
                <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                {resource.lengthMinutes} mins
              </span>
            </div>
          </div>
          <button
            onClick={() => onAdd(resource)}
            className="flex-shrink-0 px-4 py-2 text-sm bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-all font-semibold shadow-sm hover:shadow-md"
          >
            Add
          </button>
        </div>
      </ModernCard>
    );

    const PrizmContentCard = ({ content, isSelected, onToggle }) => {
      const getCategoryIcon = (category) => {
        switch (category) {
          case 'Video':
            return (
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
              </svg>
            );
          case 'Interactive':
            return (
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            );
          case 'Document':
            return (
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
            );
          case 'Image':
            return (
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
            );
          case 'Audio':
            return (
              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
              </svg>
            );
          default:
            return null;
        }
      };

      const getCategoryColor = (category) => {
        switch (category) {
          case 'Video': return 'bg-red-100 text-red-700';
          case 'Interactive': return 'bg-green-100 text-green-700';
          case 'Document': return 'bg-blue-100 text-blue-700';
          case 'Image': return 'bg-purple-100 text-purple-700';
          case 'Audio': return 'bg-yellow-100 text-yellow-700';
          default: return 'bg-gray-100 text-gray-700';
        }
      };

      const formatDuration = (seconds) => {
        const mins = Math.floor(seconds / 60);
        return mins < 60 ? `${mins}m` : `${Math.floor(mins / 60)}h ${mins % 60}m`;
      };

      const formatFileSize = (bytes) => {
        const mb = bytes / 1000000;
        return mb < 1000 ? `${mb.toFixed(1)} MB` : `${(mb / 1000).toFixed(1)} GB`;
      };

      return (
        <div
          onClick={() => onToggle(content.id)}
          className={`cursor-pointer rounded-lg border-2 transition-all hover:shadow-lg ${
            isSelected
              ? 'border-indigo-500 bg-indigo-50 shadow-md'
              : 'border-slate-200 bg-white hover:border-indigo-300'
          }`}
        >
          <div className="relative">
            <img
              src={content.thumbnailUrl}
              alt={content.title}
              className="w-full h-32 object-cover rounded-t-lg"
            />
            <div className={`absolute top-2 right-2 px-2 py-1 rounded-full text-xs font-medium flex items-center gap-1 ${getCategoryColor(content.category)}`}>
              {getCategoryIcon(content.category)}
              {content.category}
            </div>
            {isSelected && (
              <div className="absolute top-2 left-2 bg-indigo-600 text-white rounded-full p-1">
                <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                </svg>
              </div>
            )}
          </div>
          <div className="p-3 space-y-2">
            <h4 className="font-semibold text-slate-900 text-sm leading-tight line-clamp-2">{content.title}</h4>
            <p className="text-xs text-slate-600 line-clamp-2">{content.description}</p>
            <div className="flex items-center gap-2 text-xs text-slate-500">
              <span>{formatDuration(content.duration)}</span>
              <span>•</span>
              <span>{formatFileSize(content.fileSize)}</span>
            </div>
            <div className="flex items-center gap-1">
              <span className="text-yellow-500">★</span>
              <span className="text-xs text-slate-600">{content.rating}</span>
              <span className="text-xs text-slate-400 ml-1">({content.viewCount} views)</span>
            </div>
          </div>
        </div>
      );
    };

    const QuartileCard = ({ group, isSelected, onToggle }) => (
      <label
        className={`block p-4 rounded-xl border transition-all cursor-pointer ${
          isSelected ? 'border-primary-300 bg-primary-50 shadow-sm' : 'border-slate-200 bg-white hover:border-slate-300'
        }`}
      >
        <div className="flex items-start gap-3">
          <input
            type="checkbox"
            checked={isSelected}
            onChange={() => onToggle(group.key)}
            className="mt-1 text-primary-500 rounded focus:ring-primary-500"
            aria-label={`Select ${group.label}`}
          />
          <div className="flex-1 space-y-1">
            <div className="font-semibold text-slate-900 text-sm flex items-center gap-2">
              <span className={`px-2 py-1 rounded-lg text-xs font-semibold ${group.badge}`}>{group.label}</span>
              <span className="text-[11px] uppercase tracking-wide text-slate-500">{group.tier}</span>
            </div>
            <div className="text-xs text-slate-600 leading-relaxed">{group.description}</div>
            <div className="text-[11px] text-slate-500">
              {group.learners.length} learner{group.learners.length !== 1 ? 's' : ''} in this quartile
            </div>
          </div>
        </div>
      </label>
    );

    const StudentLinkModal = ({ isOpen, onClose, studentLink }) => {
      const [copied, setCopied] = useState(false);

      const copyToClipboard = async () => {
        try {
          await navigator.clipboard.writeText(studentLink);
          setCopied(true);
          setTimeout(() => setCopied(false), 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      };

      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 animate-fade-in">
          <div
            className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm"
            onClick={onClose}
          />
          <div className="relative bg-white rounded-2xl shadow-2xl max-w-2xl w-full animate-scale-in border-2 border-slate-200">
            <div className="p-8">
              <div className="flex items-start justify-between mb-6">
                <div className="flex items-center gap-3">
                  <div className="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center shadow-lg">
                    <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                    </svg>
                  </div>
                  <div>
                    <h3 className="font-serif text-2xl font-semibold text-slate-900">Assignment Created!</h3>
                    <p className="text-sm text-slate-600 mt-1">Share this link with your students</p>
                  </div>
                </div>
                <button
                  onClick={onClose}
                  className="text-slate-400 hover:text-slate-600 transition-colors p-2 hover:bg-slate-100 rounded-lg"
                  aria-label="Close modal"
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>

              <div className="space-y-4">
                <div>
                  <label className="text-sm font-semibold text-slate-700 mb-2 block">Student Launch URL</label>
                  <div className="flex items-center gap-3">
                    <div className="flex-1 px-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-xl text-slate-900 text-sm font-mono overflow-x-auto">
                      {studentLink}
                    </div>
                    <button
                      onClick={copyToClipboard}
                      className={`px-5 py-3 rounded-xl font-semibold text-sm transition-all duration-200 shadow-md ${
                        copied
                          ? 'bg-green-500 text-white'
                          : 'bg-primary-500 text-white hover:bg-primary-600 hover:shadow-lg'
                      }`}
                    >
                      {copied ? (
                        <span className="flex items-center gap-2">
                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                          </svg>
                          Copied!
                        </span>
                      ) : (
                        <span className="flex items-center gap-2">
                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                          </svg>
                          Copy Link
                        </span>
                      )}
                    </button>
                  </div>
                </div>

                <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-4">
                  <div className="flex items-start gap-3">
                    <svg className="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                      <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                    </svg>
                    <div>
                      <p className="text-sm font-semibold text-blue-900 mb-1">Next Steps</p>
                      <p className="text-sm text-blue-800">Copy this link and share it with students via Canvas, email, or your preferred communication method. Students will access their personalized assignment through this URL.</p>
                    </div>
                  </div>
                </div>
              </div>

              <div className="mt-6 flex justify-end">
                <button
                  onClick={onClose}
                  className="px-6 py-3 bg-slate-100 text-slate-700 rounded-xl font-semibold text-sm hover:bg-slate-200 transition-all duration-200 border-2 border-slate-200"
                >
                  Close
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    function TeacherApp() {
      const [viewMode, setViewMode] = useState('assignment'); // 'assignment' or 'dashboard'
      const [currentStep, setCurrentStep] = useState(1);
      const [completedSteps, setCompletedSteps] = useState(new Set());
      const [learners, setLearners] = useState([]);
      const [scheme, setScheme] = useState(null);
      const [resources, setResources] = useState([]);
      const [assignments, setAssignments] = useState([]);
      const [schools, setSchools] = useState([]);
      const [selectedSchool, setSelectedSchool] = useState('');
      const [schoolStatus, setSchoolStatus] = useState('');
      const [selectedTopic, setSelectedTopic] = useState('');
      const [selectedQuartiles, setSelectedQuartiles] = useState(new Set());
      const [status, setStatus] = useState('');
      const [aiStatus, setAiStatus] = useState('');
      const [aiExplanation, setAiExplanation] = useState('');
      const [isamsCycles, setIsamsCycles] = useState([]);
      const [isamsStatus, setIsamsStatus] = useState('');
      const [isamsLoading, setIsamsLoading] = useState(false);
      const [isamsSyncing, setIsamsSyncing] = useState(false);
      const [showStudentLinkModal, setShowStudentLinkModal] = useState(false);
      const [studentLaunchLink, setStudentLaunchLink] = useState('');

      // PRIZM Content Repository state
      const [prizmContent, setPrizmContent] = useState([]);
      const [selectedPrizmContent, setSelectedPrizmContent] = useState([]);
      const [prizmFilters, setPrizmFilters] = useState({
        category: 'All',
        topic: 'All',
        difficulty: 'All',
        search: '',
      });

      const [form, setForm] = useState({
        title: '',
        description: '',
        tasks: '',
        students: '',
        groups: '',
        returnUrl: '',
      });

      const [aiForm, setAiForm] = useState({
        learnerId: '',
        quartile: '',
        topic: '',
        week: 1,
        time: 30,
        profile: 'balanced',
        explain: false,
      });

      const quartileMeta = {
        Q1: {
          label: 'Quartile 1',
          tier: 'High readiness',
          badge: 'bg-green-100 text-green-800',
          description: 'Accelerated track with stronger mastery signals. Great fit for stretch challenges.',
        },
        Q2: {
          label: 'Quartile 2',
          tier: 'Above midpoint',
          badge: 'bg-emerald-50 text-emerald-700',
          description: 'Confident with core objectives; benefits from a balance of practice and light extension.',
        },
        Q3: {
          label: 'Quartile 3',
          tier: 'Developing',
          badge: 'bg-amber-50 text-amber-700',
          description: 'Building consistency on essentials. Prioritise scaffolded practice and feedback loops.',
        },
        Q4: {
          label: 'Quartile 4',
          tier: 'High support',
          badge: 'bg-orange-50 text-orange-700',
          description: 'Requires focused intervention with short, targeted tasks and immediate feedback.',
        },
      };

      const quartileOrder = ['Q1', 'Q2', 'Q3', 'Q4'];

      const topics = useMemo(() => {
        if (!scheme) return [];
        const schemeTopics = scheme.semesters.flatMap((sem) => sem.weeks.map((w) => w.topic));
        const resourceTopics = resources.map((r) => r.topic);
        return Array.from(new Set([...schemeTopics, ...resourceTopics])).sort();
      }, [scheme, resources]);

      const quartileGroups = useMemo(() => {
        const grouped = learners.reduce((acc, learner) => {
          const key = learner.quartile || 'Unclassified';
          if (!acc[key]) acc[key] = [];
          acc[key].push(learner);
          return acc;
        }, {});

        const orderedKeys = [
          ...quartileOrder.filter((key) => grouped[key]),
          ...Object.keys(grouped).filter((key) => !quartileOrder.includes(key)),
        ];

        return orderedKeys.map((key) => {
          const meta = quartileMeta[key] || {
            label: key,
            tier: 'Mixed readiness',
            badge: 'bg-slate-100 text-slate-700',
            description: 'Learners grouped without personal identifiers.',
          };

          return {
            key,
            label: meta.label,
            tier: meta.tier,
            badge: meta.badge,
            description: meta.description,
            learners: grouped[key] || [],
          };
        });
      }, [learners]);

      const selectedLearners = useMemo(() => {
        const selected = new Set();
        quartileGroups.forEach((group) => {
          if (selectedQuartiles.has(group.key)) {
            group.learners.forEach((learner) => selected.add(learner.email));
          }
        });
        return selected;
      }, [quartileGroups, selectedQuartiles]);

      const selectedSchoolName = useMemo(() => {
        const match = schools.find((school) => school.id === selectedSchool);
        return match ? match.name : '';
      }, [schools, selectedSchool]);

      const filteredResources = useMemo(() => {
        return resources.filter((r) => !selectedTopic || r.topic === selectedTopic);
      }, [resources, selectedTopic]);

      const filteredPrizmContent = useMemo(() => {
        let filtered = [...prizmContent];

        if (prizmFilters.category !== 'All') {
          filtered = filtered.filter(c => c.category === prizmFilters.category);
        }

        if (prizmFilters.topic !== 'All') {
          filtered = filtered.filter(c => c.topic === prizmFilters.topic);
        }

        if (prizmFilters.difficulty !== 'All') {
          filtered = filtered.filter(c => c.difficulty === prizmFilters.difficulty);
        }

        if (prizmFilters.search) {
          const searchLower = prizmFilters.search.toLowerCase();
          filtered = filtered.filter(c =>
            c.title.toLowerCase().includes(searchLower) ||
            c.description.toLowerCase().includes(searchLower) ||
            c.tags.some(tag => tag.toLowerCase().includes(searchLower))
          );
        }

        return filtered;
      }, [prizmContent, prizmFilters]);

      const togglePrizmContent = (contentId) => {
        setSelectedPrizmContent(prev => {
          if (prev.includes(contentId)) {
            return prev.filter(id => id !== contentId);
          } else {
            return [...prev, contentId];
          }
        });
      };

      const isStepComplete = (step) => {
        if (step === 1) return true; // AI step optional
        if (step === 2) return form.title && form.tasks;
        if (step === 3) return selectedLearners.size > 0 || form.students;
        return false;
      };

      useEffect(() => {
        const newCompleted = new Set();
        for (let i = 1; i <= 3; i += 1) {
          if (isStepComplete(i)) newCompleted.add(i);
        }
        setCompletedSteps(newCompleted);
      }, [form, selectedLearners]);

      useEffect(() => {
        async function loadStatic() {
          try {
            const [schemeRes, resourceRes, prizmRes] = await Promise.all([
              fetch('/api/scheme-of-work'),
              fetch('/api/content-resources'),
              fetch('/api/prizm/content'),
            ]);

            const schemeData = await schemeRes.json();
            const resourceData = await resourceRes.json();
            const prizmData = await prizmRes.json();
            setScheme(schemeData.schemeOfWork || null);
            setResources(resourceData.resources || []);
            setPrizmContent(prizmData.content || []);
          } catch (error) {
            console.error('Failed to load static data:', error);
          }
        }
        loadStatic();
      }, []);

      useEffect(() => {
        async function loadSchools() {
          try {
            const res = await fetch('/api/schools');
            const data = await res.json();
            const list = data.schools || [];
            setSchools(list);
            const urlSchool = new URLSearchParams(window.location.search).get('schoolId');
            const hasUrlSchool = urlSchool && list.some((school) => school.id === urlSchool);
            const defaultSchool = hasUrlSchool ? urlSchool : list.length > 0 ? list[0].id : '';
            setSelectedSchool(defaultSchool);
          } catch (error) {
            setSchoolStatus('Unable to load schools');
          }
        }
        loadSchools();
      }, []);

      useEffect(() => {
        if (!selectedSchool) return;
        async function loadBySchool() {
          try {
            const [learnerRes, assignmentRes] = await Promise.all([
              fetch(`/api/learners?schoolId=${selectedSchool}`),
              fetch(`/api/assignments?schoolId=${selectedSchool}`),
            ]);

            const learnersData = await learnerRes.json();
            const assignmentData = await assignmentRes.json();
            setLearners(learnersData.learners || []);
            setAssignments(assignmentData.assignments || []);
            setSchoolStatus('');
          } catch (error) {
            console.error('Failed to load school data:', error);
            setSchoolStatus('Unable to load data for this school');
          }
        }
        loadBySchool();
      }, [selectedSchool]);

      useEffect(() => {
        if (!selectedSchool) return;
        loadIsamsCycles(selectedSchool);
      }, [selectedSchool]);

      const updateForm = (key, value) => setForm((prev) => ({ ...prev, [key]: value }));

      const changeSchool = (schoolId) => {
        setSelectedSchool(schoolId);
        setSelectedQuartiles(new Set());
        setAiForm((prev) => ({ ...prev, quartile: '', learnerId: '' }));
        setStatus('');
        setAiStatus('');
        setIsamsStatus('');
      };

      const loadIsamsCycles = async (schoolId = selectedSchool) => {
        if (!schoolId) return;
        setIsamsLoading(true);
        try {
          const response = await fetch(`/api/integrations/isams/report-cycles?schoolId=${schoolId}&limit=6`);
          const data = await response.json();
          if (response.ok) {
            setIsamsCycles(data.reportCycles || []);
            setIsamsStatus('');
          } else {
            setIsamsStatus(data.error || 'Unable to load iSAMS report cycles');
          }
        } catch (error) {
          setIsamsStatus('Unable to load iSAMS report cycles');
        } finally {
          setIsamsLoading(false);
        }
      };

      const syncIsamsCycles = async () => {
        if (!selectedSchool) {
          setIsamsStatus('Select a school before syncing iSAMS data.');
          return;
        }
        setIsamsSyncing(true);
        setIsamsStatus('Syncing report cycles...');
        try {
          const response = await fetch('/api/integrations/isams/report-cycles/sync', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ schoolId: selectedSchool }),
          });
          const data = await response.json();
          if (response.ok) {
            setIsamsStatus(`Synced ${data.recordCount || 0} cycles from iSAMS.`);
            await loadIsamsCycles(selectedSchool);
          } else {
            setIsamsStatus(data.error || 'Unable to sync iSAMS report cycles');
          }
        } catch (error) {
          setIsamsStatus('Unable to sync iSAMS report cycles');
        } finally {
          setIsamsSyncing(false);
        }
      };

      const toggleQuartile = (quartileKey) => {
        setSelectedQuartiles((prev) => {
          const next = new Set(prev);
          if (next.has(quartileKey)) next.delete(quartileKey);
          else next.add(quartileKey);

          if (next.size === 0) {
            setAiForm((prevForm) => ({ ...prevForm, quartile: '', learnerId: '' }));
          } else if (!next.has(aiForm.quartile)) {
            const [firstQuartile] = Array.from(next);
            setAiForm((prevForm) => ({
              ...prevForm,
              quartile: firstQuartile,
              learnerId: resolveQuartileLearnerId(firstQuartile),
            }));
          }

          return next;
        });
      };

      const addResource = (resource) => {
        const resourceLine = `${resource.title} (${resource.type}, ${resource.lengthMinutes} mins, ${resource.topic})`;
        updateForm('tasks', form.tasks ? `${form.tasks}\n${resourceLine}` : resourceLine);
      };

      const resolveQuartileLearnerId = (quartileKey) => {
        const quartileGroup = quartileGroups.find((group) => group.key === quartileKey);
        if (quartileGroup && quartileGroup.learners && quartileGroup.learners[0]) {
          return quartileGroup.learners[0].id || '';
        }
        return '';
      };

      const resolveDifficultyProfile = (value) => {
        if (value === 'core') return { Foundation: 0.2, Core: 0.6, Stretch: 0.2 };
        if (value === 'stretch') return { Foundation: 0.1, Core: 0.4, Stretch: 0.5 };
        return { Foundation: 0.3, Core: 0.5, Stretch: 0.2 };
      };

      const normalizeTasks = (taskList) => {
        if (!Array.isArray(taskList)) return [];
        return taskList
          .map((task, index) => {
            if (typeof task === 'string') return task.trim();
            if (!task || typeof task !== 'object') return '';
            if (task.taskText) return task.taskText;
            const title = task.title || task.name || `Task ${index + 1}`;
            const duration = task.lengthMinutes || task.estimatedTimeMinutes;
            const difficulty = task.difficulty;
            const segments = [title];
            if (duration) segments.push(`${duration} mins`);
            if (difficulty) segments.push(difficulty);
            return segments.join(' • ');
          })
          .filter(Boolean);
      };

      const applyRecommendation = (data) => {
        const homework = data.homework || data.homeworkRecommendation || {};
        const tasks = normalizeTasks(homework.tasks || data.tasks);

        setForm((prev) => {
          const next = { ...prev };
          if (homework.title && !prev.title) next.title = homework.title;
          if (homework.description && !prev.description) next.description = homework.description;
          if (tasks.length) {
            const newLines = tasks.join('\n');
            next.tasks = prev.tasks ? `${prev.tasks}\n${newLines}` : newLines;
          }
          return next;
        });

        const explanations = data.explanations || {};
        const notes = (explanations.notes || []).map((note) => `• ${note}`).join('\n');
        setAiExplanation([explanations.global, notes].filter(Boolean).join('\n'));
        setAiStatus('Recommendations applied successfully');
      };

      const generateAI = async () => {
        const learnerId = aiForm.learnerId || resolveQuartileLearnerId(aiForm.quartile);
        if (!aiForm.quartile || !aiForm.topic || !learnerId) {
          setAiStatus('Please select a quartile with available learners and a topic');
          return;
        }

        setAiStatus('Generating recommendations...');
        setAiExplanation('');

        const payload = {
          learnerId,
          topic: aiForm.topic,
          maxTotalTimeMinutes: Number(aiForm.time),
          difficultyProfile: resolveDifficultyProfile(aiForm.profile),
          explain: aiForm.explain,
        };

        const useCalendarAware = aiForm.week !== '' && aiForm.week !== null && aiForm.week !== undefined;
        const calendarPayload = useCalendarAware
          ? { ...payload, weekNumber: Number(aiForm.week), topicOverride: aiForm.topic }
          : null;

        const requestRecommendation = async (url, body) => {
          const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
          });
          const data = await response.json();
          return { ok: response.ok, data };
        };

        try {
          if (calendarPayload) {
            const calendarResult = await requestRecommendation('/api/recommendations/calendar-aware', calendarPayload);
            if (calendarResult.ok) {
              applyRecommendation(calendarResult.data);
              return;
            }
          }

          const standardResult = await requestRecommendation('/api/recommend-homework', payload);
          if (standardResult.ok) {
            applyRecommendation(standardResult.data);
            return;
          }

          setAiStatus(standardResult.data && standardResult.data.error ? standardResult.data.error : 'Generation failed');
        } catch (error) {
          setAiStatus('Generation failed');
        }
      };

      const submitAssignment = async () => {
        if (!selectedSchool) {
          setStatus('Please select a school before creating an assignment');
          return;
        }

        setStatus('Creating assignment...');
        const payload = {
          title: form.title,
          description: form.description,
          tasks: form.tasks.split('\n').map((t) => t.trim()).filter(Boolean),
          students: [
            ...form.students.split(',').map((s) => s.trim()).filter(Boolean),
            ...Array.from(selectedLearners),
          ],
          groups: form.groups.split(',').map((g) => g.trim()).filter(Boolean),
          ltiReturnUrl: form.returnUrl.trim() || undefined,
          schoolId: selectedSchool,
          schoolName: selectedSchoolName,
          prizmContent: selectedPrizmContent, // Include selected PRIZM content
        };

        try {
          const response = await fetch('/api/assignments', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });

          const data = await response.json();
          if (response.ok) {
            setStudentLaunchLink(data.studentLaunchLink);
            setShowStudentLinkModal(true);
            setStatus('');
            setAssignments((prev) => [...prev, data.assignment]);
          } else {
            setStatus(data.error || 'Failed to create assignment');
          }
        } catch (error) {
          setStatus('Failed to create assignment');
        }
      };

      const steps = [
        { id: 1, title: 'AI Enhancement', description: 'Generate personalised content' },
        { id: 2, title: 'Assignment Details', description: 'Title, description, and tasks' },
        { id: 3, title: 'Learner Selection', description: 'Choose recipients and publish' },
      ];

      // Mock dashboard data
      const mockDashboardData = useMemo(() => ({
        overview: {
          totalAssignments: 47,
          completedAssignments: 38,
          averageCompletionRate: 81,
          averageScore: 76,
          activeStudents: learners.length,
        },
        recentAssignments: [
          {
            id: 'A001',
            title: 'Fractions and Decimals Practice',
            dueDate: '2026-01-15',
            assigned: 24,
            completed: 20,
            avgScore: 82,
            avgTimeMinutes: 28,
            completionRate: 83,
            topic: 'Fractions and mixed numbers',
          },
          {
            id: 'A002',
            title: 'Linear Equations Mastery',
            dueDate: '2026-01-12',
            assigned: 24,
            completed: 24,
            avgScore: 74,
            avgTimeMinutes: 35,
            completionRate: 100,
            topic: 'Linear equations and inequalities',
          },
          {
            id: 'A003',
            title: 'Geometry Transformations',
            dueDate: '2026-01-10',
            assigned: 22,
            completed: 19,
            avgScore: 79,
            avgTimeMinutes: 22,
            completionRate: 86,
            topic: 'Transformations and congruence',
          },
          {
            id: 'A004',
            title: 'Ratios and Proportions',
            dueDate: '2026-01-08',
            assigned: 24,
            completed: 22,
            avgScore: 88,
            avgTimeMinutes: 25,
            completionRate: 92,
            topic: 'Ratios and rates',
          },
          {
            id: 'A005',
            title: 'Quadratic Functions',
            dueDate: '2026-01-05',
            assigned: 20,
            completed: 18,
            avgScore: 71,
            avgTimeMinutes: 42,
            completionRate: 90,
            topic: 'Quadratic functions',
          },
        ],
        quartilePerformance: [
          {
            quartile: 'Q1',
            label: 'Quartile 1',
            students: 6,
            avgCompletionRate: 95,
            avgScore: 89,
            avgTimeMinutes: 32,
            improvement: '+8%',
          },
          {
            quartile: 'Q2',
            label: 'Quartile 2',
            students: 7,
            avgCompletionRate: 87,
            avgScore: 78,
            avgTimeMinutes: 28,
            improvement: '+5%',
          },
          {
            quartile: 'Q3',
            label: 'Quartile 3',
            students: 6,
            avgCompletionRate: 79,
            avgScore: 71,
            avgTimeMinutes: 26,
            improvement: '+12%',
          },
          {
            quartile: 'Q4',
            label: 'Quartile 4',
            students: 5,
            avgCompletionRate: 72,
            avgScore: 64,
            avgTimeMinutes: 22,
            improvement: '+15%',
          },
        ],
        performanceImpact: {
          beforeHomework: { avgScore: 68, mastery: 0.62 },
          afterHomework: { avgScore: 76, mastery: 0.71 },
          topicsImproved: ['Fractions and mixed numbers', 'Ratios and rates', 'Linear equations'],
          strugglingTopics: ['Quadratic functions', 'Systems of equations'],
        },
        weeklyActivity: [
          { week: 'Week 1', assigned: 3, completed: 3, avgScore: 74 },
          { week: 'Week 2', assigned: 4, completed: 4, avgScore: 78 },
          { week: 'Week 3', assigned: 3, completed: 3, avgScore: 72 },
          { week: 'Week 4', assigned: 5, completed: 4, avgScore: 80 },
          { week: 'This Week', assigned: 2, completed: 1, avgScore: 82 },
        ],
      }), [learners]);

      const DashboardView = () => (
        <div className="space-y-8">
          {/* Overview Cards */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <ModernCard className="p-6">
              <div className="flex items-center justify-between mb-4">
                <div className="p-3 bg-primary-100 rounded-xl">
                  <svg className="w-6 h-6 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                </div>
                <span className="text-2xl font-bold text-slate-900">{mockDashboardData.overview.totalAssignments}</span>
              </div>
              <h4 className="text-sm font-semibold text-slate-600 mb-1">Total Assignments</h4>
              <p className="text-xs text-slate-500">Created this term</p>
            </ModernCard>

            <ModernCard className="p-6">
              <div className="flex items-center justify-between mb-4">
                <div className="p-3 bg-green-100 rounded-xl">
                  <svg className="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </div>
                <span className="text-2xl font-bold text-slate-900">{mockDashboardData.overview.averageCompletionRate}%</span>
              </div>
              <h4 className="text-sm font-semibold text-slate-600 mb-1">Avg Completion Rate</h4>
              <p className="text-xs text-green-600">+3% vs last month</p>
            </ModernCard>

            <ModernCard className="p-6">
              <div className="flex items-center justify-between mb-4">
                <div className="p-3 bg-blue-100 rounded-xl">
                  <svg className="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                  </svg>
                </div>
                <span className="text-2xl font-bold text-slate-900">{mockDashboardData.overview.averageScore}%</span>
              </div>
              <h4 className="text-sm font-semibold text-slate-600 mb-1">Average Score</h4>
              <p className="text-xs text-blue-600">+8% improvement</p>
            </ModernCard>

            <ModernCard className="p-6">
              <div className="flex items-center justify-between mb-4">
                <div className="p-3 bg-purple-100 rounded-xl">
                  <svg className="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                  </svg>
                </div>
                <span className="text-2xl font-bold text-slate-900">{mockDashboardData.overview.activeStudents}</span>
              </div>
              <h4 className="text-sm font-semibold text-slate-600 mb-1">Active Students</h4>
              <p className="text-xs text-slate-500">Across all quartiles</p>
            </ModernCard>
          </div>

          {/* Performance Impact Section */}
          <ModernCard className="p-8">
            <div className="mb-6">
              <h3 className="font-serif text-2xl font-semibold text-slate-900 mb-2">Homework Impact on Performance</h3>
              <p className="text-slate-600">Measuring the effectiveness of assigned homework on learner outcomes</p>
            </div>

            <div className="grid md:grid-cols-3 gap-6 mb-8">
              <div className="text-center p-6 bg-gradient-to-br from-red-50 to-orange-50 rounded-xl border-2 border-red-100">
                <div className="text-sm font-semibold text-slate-600 mb-2">Before Homework</div>
                <div className="text-4xl font-bold text-red-600 mb-2">{mockDashboardData.performanceImpact.beforeHomework.avgScore}%</div>
                <div className="text-xs text-slate-500">Average Score</div>
                <div className="mt-3 text-sm text-slate-600">Mastery: {(mockDashboardData.performanceImpact.beforeHomework.mastery * 100).toFixed(0)}%</div>
              </div>

              <div className="flex items-center justify-center">
                <div className="text-center">
                  <svg className="w-16 h-16 text-primary-500 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                  </svg>
                  <div className="text-2xl font-bold text-green-600">+{mockDashboardData.performanceImpact.afterHomework.avgScore - mockDashboardData.performanceImpact.beforeHomework.avgScore}%</div>
                  <div className="text-sm text-slate-600">Improvement</div>
                </div>
              </div>

              <div className="text-center p-6 bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl border-2 border-green-200">
                <div className="text-sm font-semibold text-slate-600 mb-2">After Homework</div>
                <div className="text-4xl font-bold text-green-600 mb-2">{mockDashboardData.performanceImpact.afterHomework.avgScore}%</div>
                <div className="text-xs text-slate-500">Average Score</div>
                <div className="mt-3 text-sm text-slate-600">Mastery: {(mockDashboardData.performanceImpact.afterHomework.mastery * 100).toFixed(0)}%</div>
              </div>
            </div>

            <div className="grid md:grid-cols-2 gap-6">
              <div className="p-6 bg-green-50 rounded-xl border border-green-200">
                <h4 className="font-semibold text-green-900 mb-3 flex items-center gap-2">
                  <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                  </svg>
                  Top Performing Topics
                </h4>
                <ul className="space-y-2">
                  {mockDashboardData.performanceImpact.topicsImproved.map((topic, idx) => (
                    <li key={idx} className="text-sm text-green-800 flex items-start gap-2">
                      <span className="text-green-600">•</span>
                      <span>{topic}</span>
                    </li>
                  ))}
                </ul>
              </div>

              <div className="p-6 bg-amber-50 rounded-xl border border-amber-200">
                <h4 className="font-semibold text-amber-900 mb-3 flex items-center gap-2">
                  <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                  </svg>
                  Needs Attention
                </h4>
                <ul className="space-y-2">
                  {mockDashboardData.performanceImpact.strugglingTopics.map((topic, idx) => (
                    <li key={idx} className="text-sm text-amber-800 flex items-start gap-2">
                      <span className="text-amber-600">•</span>
                      <span>{topic}</span>
                    </li>
                  ))}
                </ul>
              </div>
            </div>
          </ModernCard>

          {/* Recent Assignments Table */}
          <ModernCard className="p-8">
            <div className="mb-6">
              <h3 className="font-serif text-2xl font-semibold text-slate-900 mb-2">Recent Assignments</h3>
              <p className="text-slate-600">Overview of recently assigned homework and completion metrics</p>
            </div>

            <div className="overflow-x-auto">
              <table className="w-full">
                <thead>
                  <tr className="border-b-2 border-slate-200">
                    <th className="text-left py-3 px-4 text-sm font-semibold text-slate-700">Assignment</th>
                    <th className="text-left py-3 px-4 text-sm font-semibold text-slate-700">Due Date</th>
                    <th className="text-center py-3 px-4 text-sm font-semibold text-slate-700">Completion</th>
                    <th className="text-center py-3 px-4 text-sm font-semibold text-slate-700">Avg Score</th>
                    <th className="text-center py-3 px-4 text-sm font-semibold text-slate-700">Avg Time</th>
                    <th className="text-left py-3 px-4 text-sm font-semibold text-slate-700">Topic</th>
                  </tr>
                </thead>
                <tbody>
                  {mockDashboardData.recentAssignments.map((assignment) => (
                    <tr key={assignment.id} className="border-b border-slate-100 hover:bg-slate-50 transition-colors">
                      <td className="py-4 px-4">
                        <div className="font-semibold text-slate-900 text-sm">{assignment.title}</div>
                      </td>
                      <td className="py-4 px-4 text-sm text-slate-600">{new Date(assignment.dueDate).toLocaleDateString()}</td>
                      <td className="py-4 px-4 text-center">
                        <div className="flex flex-col items-center gap-1">
                          <span className={`text-sm font-semibold ${assignment.completionRate >= 90 ? 'text-green-600' : assignment.completionRate >= 70 ? 'text-blue-600' : 'text-amber-600'}`}>
                            {assignment.completionRate}%
                          </span>
                          <span className="text-xs text-slate-500">{assignment.completed}/{assignment.assigned}</span>
                        </div>
                      </td>
                      <td className="py-4 px-4 text-center">
                        <span className={`text-sm font-semibold ${assignment.avgScore >= 80 ? 'text-green-600' : assignment.avgScore >= 70 ? 'text-blue-600' : 'text-amber-600'}`}>
                          {assignment.avgScore}%
                        </span>
                      </td>
                      <td className="py-4 px-4 text-center text-sm text-slate-600">{assignment.avgTimeMinutes}m</td>
                      <td className="py-4 px-4 text-sm text-slate-600">{assignment.topic}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </ModernCard>

          {/* Quartile Performance */}
          <ModernCard className="p-8">
            <div className="mb-6">
              <h3 className="font-serif text-2xl font-semibold text-slate-900 mb-2">Performance by Quartile</h3>
              <p className="text-slate-600">How different learner groups are responding to homework assignments</p>
            </div>

            <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
              {mockDashboardData.quartilePerformance.map((quartile) => (
                <div key={quartile.quartile} className="p-6 bg-gradient-to-br from-slate-50 to-slate-100 rounded-xl border-2 border-slate-200">
                  <div className="flex items-center justify-between mb-4">
                    <span className={`px-3 py-1 rounded-lg text-xs font-semibold ${
                      quartile.quartile === 'Q1' ? 'bg-green-100 text-green-800' :
                      quartile.quartile === 'Q2' ? 'bg-emerald-50 text-emerald-700' :
                      quartile.quartile === 'Q3' ? 'bg-amber-50 text-amber-700' :
                      'bg-orange-50 text-orange-700'
                    }`}>
                      {quartile.label}
                    </span>
                    <span className="text-xs text-green-600 font-semibold">{quartile.improvement}</span>
                  </div>

                  <div className="space-y-3">
                    <div>
                      <div className="flex items-center justify-between mb-1">
                        <span className="text-xs text-slate-600">Completion Rate</span>
                        <span className="text-sm font-bold text-slate-900">{quartile.avgCompletionRate}%</span>
                      </div>
                      <div className="h-2 bg-slate-200 rounded-full overflow-hidden">
                        <div className="h-full bg-gradient-to-r from-primary-500 to-primary-600" style={{ width: `${quartile.avgCompletionRate}%` }}></div>
                      </div>
                    </div>

                    <div>
                      <div className="flex items-center justify-between mb-1">
                        <span className="text-xs text-slate-600">Avg Score</span>
                        <span className="text-sm font-bold text-slate-900">{quartile.avgScore}%</span>
                      </div>
                      <div className="h-2 bg-slate-200 rounded-full overflow-hidden">
                        <div className="h-full bg-gradient-to-r from-green-500 to-emerald-600" style={{ width: `${quartile.avgScore}%` }}></div>
                      </div>
                    </div>

                    <div className="pt-2 border-t border-slate-300">
                      <div className="flex items-center justify-between text-xs">
                        <span className="text-slate-600">Avg Time</span>
                        <span className="font-semibold text-slate-900">{quartile.avgTimeMinutes}m</span>
                      </div>
                      <div className="flex items-center justify-between text-xs mt-1">
                        <span className="text-slate-600">Students</span>
                        <span className="font-semibold text-slate-900">{quartile.students}</span>
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </ModernCard>

          {/* Weekly Activity Chart */}
          <ModernCard className="p-8">
            <div className="mb-6">
              <h3 className="font-serif text-2xl font-semibold text-slate-900 mb-2">Weekly Activity</h3>
              <p className="text-slate-600">Assignment activity and performance trends over the past 5 weeks</p>
            </div>

            <div className="space-y-4">
              {mockDashboardData.weeklyActivity.map((week, idx) => (
                <div key={idx} className="flex items-center gap-4">
                  <div className="w-24 text-sm font-semibold text-slate-700">{week.week}</div>
                  <div className="flex-1 grid grid-cols-3 gap-4">
                    <div className="flex items-center gap-3">
                      <div className="text-xs text-slate-600 w-20">Assigned:</div>
                      <div className="flex-1 h-8 bg-slate-100 rounded-lg overflow-hidden relative">
                        <div className="h-full bg-gradient-to-r from-blue-400 to-blue-500" style={{ width: `${(week.assigned / 5) * 100}%` }}></div>
                        <span className="absolute inset-0 flex items-center justify-center text-xs font-semibold text-slate-900">{week.assigned}</span>
                      </div>
                    </div>
                    <div className="flex items-center gap-3">
                      <div className="text-xs text-slate-600 w-20">Completed:</div>
                      <div className="flex-1 h-8 bg-slate-100 rounded-lg overflow-hidden relative">
                        <div className="h-full bg-gradient-to-r from-green-400 to-green-500" style={{ width: `${(week.completed / 5) * 100}%` }}></div>
                        <span className="absolute inset-0 flex items-center justify-center text-xs font-semibold text-slate-900">{week.completed}</span>
                      </div>
                    </div>
                    <div className="flex items-center gap-3">
                      <div className="text-xs text-slate-600 w-20">Avg Score:</div>
                      <div className="flex-1 h-8 bg-slate-100 rounded-lg overflow-hidden relative">
                        <div className="h-full bg-gradient-to-r from-purple-400 to-purple-500" style={{ width: `${week.avgScore}%` }}></div>
                        <span className="absolute inset-0 flex items-center justify-center text-xs font-semibold text-slate-900">{week.avgScore}%</span>
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </ModernCard>
        </div>
      );

      return (
        <div className="min-h-screen">
          <header className="bg-white/90 backdrop-blur-xl border-b border-slate-200/60 sticky top-0 z-50 shadow-sm">
            <div className="max-w-7xl mx-auto px-6 py-5">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-4">
                  <div className="w-11 h-11 bg-gradient-to-br from-primary-500 to-primary-700 rounded-xl flex items-center justify-center shadow-lg shadow-primary-500/30">
                    <span className="text-white font-bold text-lg">IH</span>
                  </div>
                  <div>
                    <h1 className="font-serif text-xl font-bold text-slate-900">Inspired Assignments</h1>
                    <p className="text-sm text-slate-600 font-medium">Canvas LTI 1.3 • Teacher Workspace</p>
                  </div>
                </div>
                <div className="flex items-center gap-4">
                  <div className="flex items-center gap-1 bg-slate-100 p-1 rounded-lg">
                    <button
                      onClick={() => setViewMode('assignment')}
                      className={`px-4 py-2 text-sm font-semibold rounded-md transition-all duration-200 ${
                        viewMode === 'assignment'
                          ? 'bg-white text-primary-600 shadow-sm'
                          : 'text-slate-600 hover:text-slate-900'
                      }`}
                    >
                      <span className="flex items-center gap-2">
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                        </svg>
                        Create
                      </span>
                    </button>
                    <button
                      onClick={() => setViewMode('dashboard')}
                      className={`px-4 py-2 text-sm font-semibold rounded-md transition-all duration-200 ${
                        viewMode === 'dashboard'
                          ? 'bg-white text-primary-600 shadow-sm'
                          : 'text-slate-600 hover:text-slate-900'
                      }`}
                    >
                      <span className="flex items-center gap-2">
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                        Dashboard
                      </span>
                    </button>
                  </div>
                  <a href="/" className="text-sm text-slate-600 hover:text-primary-600 transition-colors duration-200 px-3 py-2 rounded-lg hover:bg-primary-50 font-medium">Overview</a>
                  <a href="/student.html" className="text-sm text-slate-600 hover:text-primary-600 transition-colors duration-200 px-3 py-2 rounded-lg hover:bg-primary-50 font-medium">Student View</a>
                  <div className="px-3.5 py-1.5 bg-gradient-to-r from-accent-100 to-accent-200 text-accent-800 text-xs font-semibold rounded-full shadow-sm">Live Demo</div>
                  <div className="hidden md:flex items-center gap-3">
                    <span className="text-xs text-slate-500 font-semibold">School</span>
                    <select
                      value={selectedSchool}
                      onChange={(e) => changeSchool(e.target.value)}
                      className="px-4 py-2 text-sm border-2 border-slate-200 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all font-medium bg-white"
                    >
                      {schools.map((school) => (
                        <option key={school.id} value={school.id}>{school.name}</option>
                      ))}
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </header>

          <div className="max-w-7xl mx-auto px-6 py-12">
            {/* Hero Section - Different for each view */}
            {viewMode === 'assignment' && (
              <div className="mb-12 animate-slide-up">
                <div className="relative overflow-hidden rounded-3xl bg-gradient-to-br from-slate-900 via-primary-900 to-primary-800 p-12 lg:p-16 text-white shadow-2xl">
                  <div className="relative z-10 max-w-4xl">
                    <div className="mb-6">
                      <span className="inline-flex items-center gap-2 px-4 py-2 bg-white/15 backdrop-blur-sm rounded-full text-sm font-semibold border border-white/20 shadow-lg">
                        <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z" />
                        </svg>
                        Modern Assignment Creation
                      </span>
                    </div>
                    <h2 className="font-serif text-4xl lg:text-5xl font-bold mb-6 leading-tight tracking-tight">
                      Task-oriented planning with AI intelligence and academic calendar context
                    </h2>
                    <p className="text-xl text-slate-100 mb-10 leading-relaxed">
                      Create personalised homework assignments with sophisticated AI recommendations, seamless Canvas integration, and Scheme of Work aware planning.
                    </p>
                    <div className="flex flex-wrap gap-3">
                      <span className="px-4 py-2.5 bg-white/10 backdrop-blur-sm rounded-xl text-sm font-semibold border border-white/20 shadow-sm">Canvas LTI 1.3</span>
                      <span className="px-4 py-2.5 bg-white/10 backdrop-blur-sm rounded-xl text-sm font-semibold border border-white/20 shadow-sm">AI Supported</span>
                      <span className="px-4 py-2.5 bg-white/10 backdrop-blur-sm rounded-xl text-sm font-semibold border border-white/20 shadow-sm">Scheme of Work Aware</span>
                      <span className="px-4 py-2.5 bg-white/10 backdrop-blur-sm rounded-xl text-sm font-semibold border border-white/20 shadow-sm">Personalised Learning Tutor</span>
                    </div>
                  </div>
                  <div className="absolute top-8 right-8 w-64 h-64 bg-gradient-to-br from-primary-400/20 to-accent-400/20 rounded-full blur-3xl"></div>
                  <div className="absolute bottom-8 right-16 w-48 h-48 bg-gradient-to-tl from-accent-400/10 to-primary-400/10 rounded-full blur-2xl"></div>
                </div>
              </div>
            )}

            {viewMode === 'dashboard' && (
              <div className="mb-12 animate-slide-up">
                <div className="relative overflow-hidden rounded-3xl bg-gradient-to-br from-emerald-900 via-teal-900 to-cyan-800 p-12 lg:p-16 text-white shadow-2xl">
                  <div className="relative z-10 max-w-4xl">
                    <div className="mb-6">
                      <span className="inline-flex items-center gap-2 px-4 py-2 bg-white/15 backdrop-blur-sm rounded-full text-sm font-semibold border border-white/20 shadow-lg">
                        <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" />
                        </svg>
                        Performance Analytics Dashboard
                      </span>
                    </div>
                    <h2 className="font-serif text-4xl lg:text-5xl font-bold mb-6 leading-tight tracking-tight">
                      Track homework impact on learner performance
                    </h2>
                    <p className="text-xl text-slate-100 mb-10 leading-relaxed">
                      Visualize completion rates, scores, and performance improvements across quartiles. Data-driven insights to optimize your teaching strategy.
                    </p>
                    <div className="flex flex-wrap gap-3">
                      <span className="px-4 py-2.5 bg-white/10 backdrop-blur-sm rounded-xl text-sm font-semibold border border-white/20 shadow-sm">Real-time Metrics</span>
                      <span className="px-4 py-2.5 bg-white/10 backdrop-blur-sm rounded-xl text-sm font-semibold border border-white/20 shadow-sm">Quartile Analysis</span>
                      <span className="px-4 py-2.5 bg-white/10 backdrop-blur-sm rounded-xl text-sm font-semibold border border-white/20 shadow-sm">Impact Tracking</span>
                      <span className="px-4 py-2.5 bg-white/10 backdrop-blur-sm rounded-xl text-sm font-semibold border border-white/20 shadow-sm">Performance Trends</span>
                    </div>
                  </div>
                  <div className="absolute top-8 right-8 w-64 h-64 bg-gradient-to-br from-cyan-400/20 to-teal-400/20 rounded-full blur-3xl"></div>
                  <div className="absolute bottom-8 right-16 w-48 h-48 bg-gradient-to-tl from-teal-400/10 to-emerald-400/10 rounded-full blur-2xl"></div>
                </div>
              </div>
            )}

            {/* Assignment Creation View */}
            {viewMode === 'assignment' && (
              <>
                <div className="mb-8 animate-fade-in workflow-nav" style={{ animationDelay: '0.2s' }}>
                  <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 flex-1">
                      {steps.map((step) => (
                        <StepIndicator
                          key={step.id}
                          step={step.id}
                          currentStep={currentStep}
                          title={step.title}
                          isComplete={completedSteps.has(step.id)}
                          onClick={() => setCurrentStep(step.id)}
                        />
                      ))}
                    </div>
                    <FloatingActionButton onClick={submitAssignment}>Create Assignment</FloatingActionButton>
                  </div>
                </div>

                <div className="grid lg:grid-cols-4 gap-8">
                  <div className="lg:col-span-3 space-y-8">
                    <ModernCard className="p-8">
                      <div className="mb-6">
                        <h3 className="font-serif text-2xl font-semibold text-slate-900 mb-2">Assignment Details</h3>
                        <p className="text-slate-600">Create the foundation of your assignment with clear objectives and structured tasks.</p>
                      </div>

                      <div className="space-y-6">
                        <div className="grid md:grid-cols-2 gap-6">
                          <div className="space-y-2">
                            <label className="text-sm font-semibold text-slate-700">Assignment Title</label>
                            <input
                              type="text"
                              value={form.title}
                              onChange={(e) => updateForm('title', e.target.value)}
                              placeholder="e.g., Fractions and Decimals Practice"
                              className="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
                            />
                          </div>
                          <div className="space-y-2">
                            <label className="text-sm font-semibold text-slate-700">Student Instructions</label>
                            <input
                              type="text"
                              value={form.description}
                              onChange={(e) => updateForm('description', e.target.value)}
                              placeholder="Key reminders or context for students"
                              className="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
                            />
                          </div>
                        </div>

                        <div className="space-y-2">
                          <label className="text-sm font-semibold text-slate-700">Assignment Tasks</label>
                          <p className="text-xs text-slate-500">Enter each task on a new line. Be specific about expectations and deliverables.</p>
                          <textarea
                            value={form.tasks}
                            onChange={(e) => updateForm('tasks', e.target.value)}
                            placeholder={`Read Chapter 5: Introduction to Fractions\nComplete Practice Problems 1-15\nSubmit photo of your work\nWrite one paragraph reflection on what you learned`}
                            rows={6}
                            className="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all resize-none"
                          />
                        </div>

                        <div className="grid md:grid-cols-3 gap-6">
                          <div className="space-y-2">
                            <label className="text-sm font-semibold text-slate-700">Additional Students</label>
                            <input
                              type="text"
                              value={form.students}
                              onChange={(e) => updateForm('students', e.target.value)}
                              placeholder="student1@school.edu, student2@school.edu"
                              className="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
                            />
                          </div>
                          <div className="space-y-2">
                            <label className="text-sm font-semibold text-slate-700">Groups</label>
                            <input
                              type="text"
                              value={form.groups}
                              onChange={(e) => updateForm('groups', e.target.value)}
                              placeholder="Period 2, Algebra Club"
                              className="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
                            />
                          </div>
                          <div className="space-y-2">
                            <label className="text-sm font-semibold text-slate-700">Canvas Return URL</label>
                            <input
                              type="text"
                              value={form.returnUrl}
                              onChange={(e) => updateForm('returnUrl', e.target.value)}
                              placeholder="https://canvas.example.com/courses/123"
                              className="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
                            />
                          </div>
                        </div>
                      </div>
                    </ModernCard>

                    {currentStep === 2 && (
                      <ModernCard className="p-8">
                        <div className="mb-6">
                          <h3 className="font-serif text-2xl font-semibold text-slate-900 mb-2">Resource Library</h3>
                          <p className="text-slate-600">Browse and add curated content to your assignment tasks.</p>
                        </div>

                        <div className="mb-6">
                          <div className="flex items-center gap-4">
                            <label className="text-sm font-semibold text-slate-700">Filter by topic:</label>
                            <select
                              value={selectedTopic}
                              onChange={(e) => setSelectedTopic(e.target.value)}
                              className="px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
                            >
                              <option value="">All topics</option>
                              {topics.map((topic) => (
                                <option key={topic} value={topic}>{topic}</option>
                              ))}
                            </select>
                          </div>
                        </div>

                        <div className="grid md:grid-cols-2 gap-4">
                          {filteredResources.length > 0 ? (
                            filteredResources.map((resource) => (
                              <ResourceCard key={resource.id} resource={resource} onAdd={addResource} />
                            ))
                          ) : (
                            <div className="col-span-2 text-center py-12 text-slate-500">No resources available for the selected topic.</div>
                          )}
                        </div>
                      </ModernCard>
                    )}

                    {currentStep === 2 && (
                      <ModernCard className="p-8 bg-gradient-to-br from-indigo-50 to-purple-50 border-2 border-indigo-200">
                        <div className="mb-6">
                          <div className="flex items-center gap-3 mb-2">
                            <div className="p-2 bg-indigo-600 rounded-lg">
                              <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                              </svg>
                            </div>
                            <h3 className="font-serif text-2xl font-semibold text-slate-900">PRIZM Content Repository</h3>
                          </div>
                          <p className="text-slate-700">Browse and attach digital assets that students will experience during their homework.</p>
                        </div>

                        <div className="mb-6 space-y-4">
                          <div className="grid md:grid-cols-3 gap-4">
                            <div className="space-y-2">
                              <label className="text-sm font-semibold text-slate-700">Category</label>
                              <select
                                value={prizmFilters.category}
                                onChange={(e) => setPrizmFilters((prev) => ({ ...prev, category: e.target.value }))}
                                className="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all bg-white"
                              >
                                <option value="All">All Categories</option>
                                <option value="Video">Video</option>
                                <option value="Interactive">Interactive</option>
                                <option value="Document">Document</option>
                                <option value="Image">Image</option>
                                <option value="Audio">Audio</option>
                              </select>
                            </div>
                            <div className="space-y-2">
                              <label className="text-sm font-semibold text-slate-700">Topic</label>
                              <select
                                value={prizmFilters.topic}
                                onChange={(e) => setPrizmFilters((prev) => ({ ...prev, topic: e.target.value }))}
                                className="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all bg-white"
                              >
                                <option value="All">All Topics</option>
                                {topics.map((topic) => (
                                  <option key={topic} value={topic}>{topic}</option>
                                ))}
                              </select>
                            </div>
                            <div className="space-y-2">
                              <label className="text-sm font-semibold text-slate-700">Search</label>
                              <input
                                type="text"
                                value={prizmFilters.search}
                                onChange={(e) => setPrizmFilters((prev) => ({ ...prev, search: e.target.value }))}
                                placeholder="Search content..."
                                className="w-full px-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all"
                              />
                            </div>
                          </div>
                        </div>

                        {selectedPrizmContent.length > 0 && (
                          <div className="mb-6 p-4 bg-white rounded-lg border-2 border-indigo-300">
                            <div className="flex items-center justify-between mb-3">
                              <h4 className="font-semibold text-slate-900">Selected Content ({selectedPrizmContent.length})</h4>
                              <button
                                onClick={() => setSelectedPrizmContent([])}
                                className="text-sm text-red-600 hover:text-red-700 font-medium"
                              >
                                Clear All
                              </button>
                            </div>
                            <div className="flex flex-wrap gap-2">
                              {selectedPrizmContent.map((id) => {
                                const content = prizmContent.find(c => c.id === id);
                                return content ? (
                                  <div key={id} className="flex items-center gap-2 px-3 py-1 bg-indigo-100 text-indigo-900 rounded-full text-sm">
                                    <span>{content.title}</span>
                                    <button
                                      onClick={() => setSelectedPrizmContent(prev => prev.filter(cId => cId !== id))}
                                      className="hover:text-red-600"
                                    >
                                      ✕
                                    </button>
                                  </div>
                                ) : null;
                              })}
                            </div>
                          </div>
                        )}

                        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[600px] overflow-y-auto">
                          {filteredPrizmContent.length > 0 ? (
                            filteredPrizmContent.map((content) => (
                              <PrizmContentCard
                                key={content.id}
                                content={content}
                                isSelected={selectedPrizmContent.includes(content.id)}
                                onToggle={togglePrizmContent}
                              />
                            ))
                          ) : (
                            <div className="col-span-3 text-center py-12 text-slate-500">
                              No content found matching your filters.
                            </div>
                          )}
                        </div>
                      </ModernCard>
                    )}

                    {currentStep === 1 && (
                      <div className="animate-scale-in space-y-8">
                        <ModernCard className="p-8">
                          <div className="mb-6">
                            <h3 className="font-serif text-2xl font-semibold text-slate-900 mb-2">AI-Enhanced Planning</h3>
                            <p className="text-slate-600">Generate personalised content recommendations based on quartiles and curriculum context.</p>
                          </div>

                          <div className="space-y-6">
                            <div className="grid md:grid-cols-2 gap-6">
                              <div className="space-y-2">
                                <label className="text-sm font-semibold text-slate-700">Select Quartile</label>
                                <select
                                  value={aiForm.quartile}
                                  onChange={(e) => setAiForm((prev) => ({
                                    ...prev,
                                    quartile: e.target.value,
                                    learnerId: resolveQuartileLearnerId(e.target.value),
                                  }))}
                                  className="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
                                >
                                  <option value="">Choose quartile for personalisation</option>
                                  {quartileGroups.map((group) => (
                                    <option key={group.key} value={group.key}>
                                      {group.label} ({group.learners.length} learners)
                                    </option>
                                  ))}
                                </select>
                              </div>
                              <div className="space-y-2">
                                <label className="text-sm font-semibold text-slate-700">Topic Focus</label>
                                <select
                                  value={aiForm.topic}
                                  onChange={(e) => setAiForm((prev) => ({ ...prev, topic: e.target.value }))}
                                  className="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
                                >
                                  <option value="">Select topic area</option>
                                  {topics.map((topic) => (
                                    <option key={topic} value={topic}>{topic}</option>
                                  ))}
                                </select>
                              </div>
                            </div>

                            <div className="grid md:grid-cols-3 gap-6">
                              <div className="space-y-2">
                                <label className="text-sm font-semibold text-slate-700">Time Budget</label>
                                <div className="relative">
                                  <input
                                    type="number"
                                    value={aiForm.time}
                                    onChange={(e) => setAiForm((prev) => ({ ...prev, time: e.target.value }))}
                                    min="5"
                                    step="5"
                                    className="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
                                  />
                                  <span className="absolute right-4 top-3 text-sm text-slate-500">minutes</span>
                                </div>
                              </div>
                              <div className="space-y-2">
                                <label className="text-sm font-semibold text-slate-700">Difficulty Mix</label>
                                <select
                                  value={aiForm.profile}
                                  onChange={(e) => setAiForm((prev) => ({ ...prev, profile: e.target.value }))}
                                  className="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
                                >
                                  <option value="balanced">Balanced Mix</option>
                                  <option value="core">Focus on Core</option>
                                  <option value="stretch">Stretch Challenges</option>
                                </select>
                              </div>
                              <div className="space-y-2">
                                <label className="text-sm font-semibold text-slate-700">Academic Week</label>
                                <input
                                  type="number"
                                  value={aiForm.week}
                                  onChange={(e) => setAiForm((prev) => ({ ...prev, week: e.target.value }))}
                                  min="1"
                                  max="18"
                                  className="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
                                />
                              </div>
                            </div>

                            <div className="flex items-center justify-between">
                              <label className="flex items-center gap-3">
                                <input
                                  type="checkbox"
                                  checked={aiForm.explain}
                                  onChange={(e) => setAiForm((prev) => ({ ...prev, explain: e.target.checked }))}
                                  className="rounded text-primary-500 focus:ring-primary-500"
                                />
                                <span className="text-sm text-slate-700">Include explanation of AI choices</span>
                              </label>
                              <FloatingActionButton onClick={generateAI}>AI Recommendations</FloatingActionButton>
                            </div>

                            {aiStatus && (
                              <div
                                className={`p-4 rounded-xl border ${
                                  aiStatus.includes('success')
                                    ? 'bg-green-50 border-green-200 text-green-700'
                                    : 'bg-blue-50 border-blue-200 text-blue-700'
                                }`}
                              >
                                {aiStatus}
                              </div>
                            )}

                            {aiExplanation && (
                              <ModernCard className="p-6 bg-slate-50">
                                <h4 className="font-semibold text-slate-900 mb-3">AI Explanation</h4>
                                <pre className="text-sm text-slate-700 whitespace-pre-wrap leading-relaxed">{aiExplanation}</pre>
                              </ModernCard>
                            )}
                          </div>
                        </ModernCard>
                      </div>
                    )}

                    {currentStep === 3 && (
                      <div className="animate-scale-in space-y-8">
                        <ModernCard className="p-8">
                          <div className="mb-6">
                            <h3 className="font-serif text-2xl font-semibold text-slate-900 mb-2">Learner Selection</h3>
                            <p className="text-slate-600">Choose which quartiles will receive this assignment.</p>
                          </div>

                          <div className="grid md:grid-cols-2 gap-6 mb-8">
                            {quartileGroups.map((group) => (
                              <QuartileCard
                                key={group.key}
                                group={group}
                                isSelected={selectedQuartiles.has(group.key)}
                                onToggle={toggleQuartile}
                              />
                            ))}
                          </div>

                          <div className="border-t border-slate-200 pt-6">
                            <div className="flex items-center justify-between">
                              <div className="text-sm text-slate-600">
                                {selectedQuartiles.size} quartile{selectedQuartiles.size !== 1 ? 's' : ''} selected • {selectedLearners.size} learner{selectedLearners.size !== 1 ? 's' : ''}
                              </div>
                              <FloatingActionButton onClick={() => setCurrentStep(2)} variant="secondary">Return to details</FloatingActionButton>
                            </div>

                            {status && (
                              <div
                                className={`mt-4 p-4 rounded-xl border ${
                                  status.includes('created')
                                    ? 'bg-green-50 border-green-200 text-green-700'
                                    : 'bg-blue-50 border-blue-200 text-blue-700'
                                }`}
                              >
                                {status}
                              </div>
                            )}
                          </div>
                        </ModernCard>
                      </div>
                    )}
                  </div>

                  <div className="space-y-6">
                    <ModernCard className="p-6">
                      <h4 className="font-semibold text-slate-900 mb-4">Assignment Progress</h4>
                      <div className="space-y-3">
                        <div className="flex justify-between text-sm">
                          <span className="text-slate-600">AI Enhancement</span>
                          <span className={completedSteps.has(1) ? 'text-green-600' : 'text-slate-400'}>{completedSteps.has(1) ? '✓' : '○'}</span>
                        </div>
                        <div className="flex justify-between text-sm">
                          <span className="text-slate-600">Title & Tasks</span>
                          <span className={completedSteps.has(2) ? 'text-green-600' : 'text-slate-400'}>{completedSteps.has(2) ? '✓' : '○'}</span>
                        </div>
                        <div className="flex justify-between text-sm">
                          <span className="text-slate-600">Learner Selection</span>
                          <span className={completedSteps.has(3) ? 'text-green-600' : 'text-slate-400'}>{completedSteps.has(3) ? '✓' : '○'}</span>
                        </div>
                      </div>
                      <div className="mt-4 h-2 bg-slate-200 rounded-full overflow-hidden">
                        <div className="h-full bg-gradient-to-r from-primary-500 to-primary-600 transition-all duration-500" style={{ width: `${(completedSteps.size / 3) * 100}%` }}></div>
                      </div>
                    </ModernCard>

                    <ModernCard className="p-6">
                      <h4 className="font-semibold text-slate-900 mb-4">Quick Stats</h4>
                      <div className="space-y-3">
                        <div className="flex justify-between text-sm">
                          <span className="text-slate-600">Active school</span>
                          <span className="font-medium">{selectedSchoolName || 'None selected'}</span>
                        </div>
                        <div className="flex justify-between text-sm">
                          <span className="text-slate-600">Available learners</span>
                          <span className="font-medium">{learners.length}</span>
                        </div>
                        <div className="flex justify-between text-sm">
                          <span className="text-slate-600">Content resources</span>
                          <span className="font-medium">{resources.length}</span>
                        </div>
                        <div className="flex justify-between text-sm">
                          <span className="text-slate-600">Topics covered</span>
                          <span className="font-medium">{topics.length}</span>
                        </div>
                        <div className="flex justify-between text-sm">
                          <span className="text-slate-600">Past assignments</span>
                          <span className="font-medium">{assignments.length}</span>
                        </div>
                      </div>
                    </ModernCard>

                    <ModernCard className="p-6">
                      <div className="flex items-center justify-between mb-2">
                        <div>
                          <h4 className="font-semibold text-slate-900">iSAMS Report Cycles</h4>
                          <p className="text-xs text-slate-500">Sync and review report cycles for the active school.</p>
                        </div>
                        <div className="flex items-center gap-2">
                          <button
                            type="button"
                            onClick={() => loadIsamsCycles(selectedSchool)}
                            className="text-xs px-3 py-1 rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50"
                            disabled={isamsLoading}
                          >
                            {isamsLoading ? 'Refreshing...' : 'Refresh'}
                          </button>
                          <button
                            type="button"
                            onClick={syncIsamsCycles}
                            className="text-xs px-3 py-1 rounded-lg bg-primary-500 text-white hover:bg-primary-600 disabled:bg-primary-300"
                            disabled={isamsSyncing}
                          >
                            {isamsSyncing ? 'Syncing...' : 'Sync iSAMS'}
                          </button>
                        </div>
                      </div>

                      {isamsStatus && (
                        <div
                          className={`mt-3 p-3 rounded-lg text-xs border ${
                            isamsStatus.includes('Synced')
                              ? 'bg-green-50 border-green-200 text-green-700'
                              : 'bg-amber-50 border-amber-200 text-amber-700'
                          }`}
                        >
                          {isamsStatus}
                        </div>
                      )}

                      <div className="mt-4 space-y-3">
                        {isamsLoading && <p className="text-xs text-slate-500">Loading report cycles…</p>}
                        {!isamsLoading && isamsCycles.length === 0 && (
                          <p className="text-xs text-slate-500">No report cycles found yet. Run a sync to fetch them.</p>
                        )}
                        {!isamsLoading &&
                          isamsCycles.map((cycle) => (
                            <div key={cycle.id} className="border border-slate-200 rounded-lg p-3">
                              <div className="text-sm font-medium text-slate-900">{cycle.name || 'Unnamed cycle'}</div>
                              <div className="text-xs text-slate-500">
                                {cycle.start_date || 'TBD'} → {cycle.end_date || 'TBD'}
                              </div>
                              <div className="text-xs text-primary-700">{cycle.status || 'Status unknown'}</div>
                            </div>
                          ))}
                      </div>
                    </ModernCard>

                    <ModernCard className="p-6">
                      <h4 className="font-semibold text-slate-900 mb-4">Recent Assignments</h4>
                      <div className="space-y-3">
                        {assignments.length === 0 ? (
                          <p className="text-sm text-slate-500">No assignments yet</p>
                        ) : (
                          assignments.slice(-3).map((assignment) => (
                            <div key={assignment.id} className="p-3 border border-slate-200 rounded-lg">
                              <div className="font-medium text-sm text-slate-900 mb-1">{assignment.title}</div>
                              <div className="text-xs text-slate-500">{new Date(assignment.createdAt).toLocaleDateString()}</div>
                              <div className="text-xs text-primary-700">{assignment.schoolName}</div>
                            </div>
                          ))
                        )}
                      </div>
                    </ModernCard>
                  </div>
                </div>
              </>
            )}

            {/* Dashboard View */}
            {viewMode === 'dashboard' && (
              <DashboardView />
            )}
          </div>

          <StudentLinkModal
            isOpen={showStudentLinkModal}
            onClose={() => setShowStudentLinkModal(false)}
            studentLink={studentLaunchLink}
          />
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<TeacherApp />);
  </script>
</body>
</html>
